"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var isChildClassOf=(isChildClassOf=cc.js.isChildClassOf)||cc.isChildClassOf,ResAgent=function(){function e(){this._mapResDepends={},this._mapResUses={},this._loadingCount=0,this._waitFrees={}}return e.prototype.del=function(){},e.prototype.init=function(){},e.prototype._makeArgsUseRes=function(){if(arguments.length<2||"string"!=typeof arguments[0]||"string"!=typeof arguments[1])throw new Error("Arguments is invalid !");for(var e={keyUse:arguments[0],path:arguments[1]},t=2;t<arguments.length;++t)2==t&&isChildClassOf(arguments[t],cc.RawAsset)?e.type=arguments[t]:"function"==typeof arguments[t]&&(t+1<arguments.length&&"function"==typeof arguments[t+1]?e.onProgess=arguments[t]:e.onCompleted=arguments[t]);return e},e.prototype._makeArgsFreeRes=function(){if(arguments.length<1||"string"!=typeof arguments[0])throw new Error("Arguments is invalid !");for(var e={keyUse:arguments[0],path:arguments[1]},t=2;t<arguments.length;++t)e.type=arguments[t];return e},e.prototype.getResUseInfo=function(e){return this._mapResUses[e]},e.prototype.useRes=function(){var r=this;++this._loadingCount;function e(e,t){if(--r._loadingCount,e)return o.onCompleted&&o.onCompleted(e),void(r._loadingCount<=0&&r._doWaitFrees());var s=r._getKey(o.path,o.type),n=i[o.keyUse];n||(i[o.keyUse]=n=[]),n.indexOf(s)<0&&(function e(t,s){var n=d[t];if(!n||!n.numDepended){var r=n?d[t]:d[t]={depends:[],numDepended:0};if(s&&s.dependKeys&&Array.isArray(s.dependKeys))for(var o=0,i=s.dependKeys;o<i.length;o++){var a,p=i[o];p!==t&&(e(p,cc.loader._cache[p]),a=d[p],r.depends.push(p),++a.numDepended)}}}(s,r._getItemFromLoaderCache(o.path,o.type)),e=d[s],n.push(s),++e.numDepended),o.onCompleted&&o.onCompleted(null,t),r._loadingCount<=0&&r._doWaitFrees()}var o=this._makeArgsUseRes.apply(this,arguments),d=this._mapResDepends,i=this._mapResUses;this._removeWaitFree(o);var t=cc.loader.getRes(o.path,o.type);t?e(null,t):cc.loader.loadRes(o.path,o.type,o.onProgess,e)},e.prototype.freeRes=function(){var e,n,t,s,r,o=this._makeArgsFreeRes.apply(this,arguments);function i(e){var t,s=n[e];--s.numDepended,s.numDepended<=0&&(t=s.depends,s.depends=[],cc.loader.release(e),t.forEach(function(e){i(e)}))}0<this._loadingCount?this._addWaitFree(o):(e=o.path?this._getKey(o.path,o.type):null,n=this._mapResDepends,s=(t=this._mapResUses)[o.keyUse],e?-1<(r=s.indexOf(e))&&(s.splice(r,1),i(e,o.type)):(t[o.keyUse]=[],s&&s.forEach(function(e){i(e)})))},e.prototype._getItemFromLoaderCache=function(e,t){var s=cc.loader,n=s._cache[e];if(!n){t=this._getKey(e,t);if(!t)return null;n=s._cache[t]}return n&&n.alias&&(n=n.alias),n},e.prototype._getKey=function(e,t){var s,n=cc.loader,t=n._getResUuid(e,t,null,!0);return t&&(s=n._getReferenceKey(t)),s},e.prototype._doWaitFrees=function(){var e,t=this._waitFrees;for(e in t){var s,n=t[e];for(s in n)this.freeRes(n[s].keyUse,n[s].path,n[s].type)}this._waitFrees={}},e.prototype._addWaitFree=function(e){this._waitFrees[e.keyUse]||(this._waitFrees[e.keyUse]={}),this._waitFrees[e.keyUse][e.path]=e},e.prototype._removeWaitFree=function(e){var t,s=this._waitFrees;s[e.keyUse]&&(t=s[e.keyUse],e.path?(t[e.path]&&delete t[e.path],Object.keys(t).length||delete s[e.keyUse]):delete s[e.keyUse])},e}();exports.ResAgent=ResAgent,exports.resAgent=new ResAgent,window&&(window.resAgent=exports.resAgent);