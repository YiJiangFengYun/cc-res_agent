"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,s=1,i=arguments.length;s<i;s++)for(var n in t=arguments[s])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};Object.defineProperty(exports,"__esModule",{value:!0});var isChildClassOf=(isChildClassOf=cc.js.isChildClassOf)||cc.isChildClassOf,DELAY_FREE_DEFAULT=60;function findIndex(e,t){for(var s=e.length,i=0;i<s;++i)if(t(e[i]))return i;return-1}var ResAgent=function(){function e(e){void 0===e&&(e=DELAY_FREE_DEFAULT),this._mapResUses={},this._loadingCount=0,this._waitFrees={},this._isDestroyed=!1,this._time=0,this._intervalIndex=0,this._delayFree=0,this._delayFree=e,this._intervalIndex=setInterval(this._update.bind(this),1e3)}return e.prototype.del=function(){this._isDestroyed=!0,clearInterval(this._intervalIndex),this._intervalIndex=0,this._clear()},e.prototype.init=function(e){void 0===e&&(e=DELAY_FREE_DEFAULT),this._delayFree=e,this._clear()},e.prototype.getResUseInfo=function(e){return this._mapResUses[e]},e.prototype.useRes=function(){var i,n,e,t,r=this;this._isDestroyed||(++this._loadingCount,i=this._makeArgsUseRes.apply(this,arguments),n=this._mapResUses,e=function(e,t){var s;r._isDestroyed||(--r._loadingCount,e?i.onCompleted&&i.onCompleted(e):((e=n[i.keyUse])||(n[i.keyUse]=e=[]),s=[i.path,i.type],e.every(function(e){return e[0]!==s[0]||e[1]!==s[1]})&&(t.addRef(),e.push(s)),i.onCompleted&&i.onCompleted(null,t)))},this._removeWaitFree(i),(t=cc.resources.get(i.path,i.type))?e(null,t):cc.resources.load(i.path,i.type,i.onProgess,e))},e.prototype.freeRes=function(){var t,e,s=this;this._isDestroyed||((t=this._makeArgsFreeRes.apply(this,arguments)).path?this._addWaitFree(t):(e=this._mapResUses[t.keyUse])&&e.forEach(function(e){s._addWaitFree(__assign(__assign({},t),{path:e[0],type:e[1]}))}))},e.prototype._checkAndDoWaitFrees=function(){var e,t=this._waitFrees,s=this._time;for(e in t){var i,n=t[e];for(i in n){for(var r=n[i],o=r.length,a=o-1;0<=a&&r[a].expires<=s;--a)--o,this._doFreeRes(e,i,null===r[a].type?void 0:r[a].type);(r.length=o)||delete n[i]}Object.keys(n).length||delete t[e]}},e.prototype._doFreeRes=function(e,t,s){var i=this._mapResUses[e],n=[t,s],s=i?i.filter(function(e){if(e[0]===n[0]&&e[1]===n[1])return e}):[];0<s.length&&s.forEach(function(e){i.splice(i.indexOf(e),1),cc.resources.get(e[0],e[1]).decRef()})},e.prototype._addWaitFree=function(t){var e=this._waitFrees[t.keyUse];e||(this._waitFrees[t.keyUse]=e={});var s=e[t.path];s||(e[t.path]=s=[]);e=findIndex(s,function(e){return e.type===(t.type||null)});e<0?s.push({type:t.type||null,expires:this._time+this._delayFree}):s[e].expires=this._time+this._delayFree,s.sort(function(e,t){return t.expires-e.expires})},e.prototype._removeWaitFree=function(t){var e,s,i,n=this._waitFrees;n[t.keyUse]&&(e=n[t.keyUse],t.path?(!(s=e[t.path])||-1<(i=findIndex(s,function(e){return e.type===(t.type||null)}))&&s.splice(i,1),s&&!s.length&&delete e[t.path],Object.keys(e).length||delete n[t.keyUse]):delete n[t.keyUse])},e.prototype._update=function(){++this._time,this._loadingCount<=0&&this._checkAndDoWaitFrees()},e.prototype._clear=function(){this._loadingCount=0;var e,t=this._mapResUses;for(e in t){var s=t[e];s&&s.forEach(function(e){cc.resources.get(e[0],e[1]).decRef()})}this._mapResUses={},this._waitFrees={},this._time=0},e.prototype._makeArgsUseRes=function(){if(arguments.length<2||"string"!=typeof arguments[0]||"string"!=typeof arguments[1])throw new Error("Arguments is invalid !");for(var e={keyUse:arguments[0],path:arguments[1]},t=2;t<arguments.length;++t)2==t&&isChildClassOf(arguments[t],cc.Asset)?e.type=arguments[t]:"function"==typeof arguments[t]&&(t+1<arguments.length&&"function"==typeof arguments[t+1]?e.onProgess=arguments[t]:e.onCompleted=arguments[t]);return e},e.prototype._makeArgsFreeRes=function(){if(arguments.length<1||"string"!=typeof arguments[0])throw new Error("Arguments is invalid !");for(var e={keyUse:arguments[0],path:arguments[1]},t=2;t<arguments.length;++t)e.type=arguments[t];return e},e}();exports.ResAgent=ResAgent,exports.resAgent=new ResAgent,window&&(window.resAgent=exports.resAgent);